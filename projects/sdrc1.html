<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Jesung Park</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Personal website of Jesung Park">
  <meta name="author" content="Jesung Park">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNQ01YG9MY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-ZNQ01YG9MY');
  </script>

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WHH4ZFP');</script>
  <!-- End Google Tag Manager -->

  <!--CSS-->
  <link rel="stylesheet" href="../assets/css/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
  <link rel="stylesheet" href="../assets/css/all.css">
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    body,h1,h2,h3,h4,h5,h6 {font-family: "Raleway", sans-serif}
  </style>

  <link rel="shortcut icon" type="image/ico" href="../assets/ico/j-icon.ico">
  <link rel="icon" type="image/x-icon" href="../assets/ico/j-icon.ico">
  
  <!--MathJax-->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script>
    MathJax = {
        chtml: { displayAlign: 'left' }
    };
  </script>
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
</head>

<body class="w3-light-grey w3-content Site" style="max-width:1600px">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WHH4ZFP"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Sidebar/menu -->
  <nav class="w3-sidebar w3-collapse w3-white w3-animate-left" style="z-index:3;width:300px;" id="mySidebar"><br>
    <div class="w3-container">
      <a href="#" onclick="w3_close()" class="w3-hide-large w3-right w3-jumbo w3-padding w3-hover-grey" title="close menu">
        <i class="fa fa-remove"></i>
      </a>
      <img src="../assets/img/about/chump.jpg" style="width:95%;" class="w3-round"><br><br>
      <h4><b>Jesung Park</b></h4>
      <p class="w3-text-grey">A collection of random projects and musings</p>
    </div>
    <div class="w3-bar-block">
      <a href="../about.html" onclick="w3_close()" class="w3-bar-item w3-button w3-padding"><i class="fa fa-user fa-fw w3-margin-right"></i>ABOUT</a>
      <a href="../index.html" onclick="w3_close()" class="w3-bar-item w3-button w3-padding"><i class="fab fa-microblog fa-fw w3-margin-right"></i>BLOG</a>
      <a href="../projects.html" onclick="w3_close()" class="w3-bar-item w3-button w3-padding w3-text-teal"><i class="fa fa-th-large fa-fw w3-margin-right"></i>PROJECTS</a>
    </div>
    <div class="w3-panel w3-large">
      <a href="https://www.linkedin.com/in/jesungpark/" target="_blank"><i class="fab fa-linkedin fa-fw fa-2x w3-hover-opacity"></i></a>
      <a href="https://github.com/jesung" target="_blank"><i class="fab fa-github fa-fw fa-2x w3-hover-opacity"></i></a>
    </div>
  </nav>

  <!-- Overlay effect when opening sidebar on small screens -->
  <div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

  <!-- !PAGE CONTENT! -->
  <div class="w3-main Site-content" style="margin-left:300px">

        <!-- Header -->
        <header id="portfolio">
          <a href="#"><img src="../assets/img/about/chump.jpg" style="width:65px;" class="w3-circle w3-right w3-margin w3-hide-large w3-hover-opacity"></a>
          <span class="w3-button w3-hide-large w3-xxlarge w3-hover-text-grey" onclick="w3_open()"><i class="fa fa-bars"></i></span>
          <div class="w3-container">
            <br>
            <h1><b>Self-Driving Race Car with Path Optimization</b></h1>

            <div class="w3-section w3-bottombar w3-padding-4">
              <!--<span class="w3-margin-right">Filter:</span>
              <button class="w3-button w3-black">ALL</button>
              <button class="w3-button w3-white"><i class="fa fa-diamond w3-margin-right"></i>Design</button>
              <button class="w3-button w3-white w3-hide-small"><i class="fa fa-photo w3-margin-right"></i>Photos</button>
              <button class="w3-button w3-white w3-hide-small"><i class="fa fa-map-pin w3-margin-right"></i>Art</button>
              -->
            </div>
          </div>
        </header>

        <!-- Article body-->
        <article class="w3-row-padding">
          <div class="clearfix">
          </div>
          <!-- intro -->
          <div class="w3-full w3-container w3-margin-bottom">
              <p>
                Following my completion of the <a href="https://www.coursera.org/specializations/self-driving-cars" target="_blank">Self Driving Car specialization</a> on Coursera, I wanted to take the learnings into something more practical. A limitation with using CARLA, which was the simulator used in the course, was the lack of realistic physics. The car behaved in strange ways when at the limit of tire grip. To address this, I turned to something familiar – racing games. Assetto Corsa was a game I had experience with and has a healthy modding community so it became my platform of choice for this project.
              </p>
              <p>
                My goal for this project was to build a connection between the racing game and the back-end algorithm and use a basic “traditional” approach to generate an optimal target path for the car to follow. This would pave the way for future projects using more modern approaches such as deep learning or reinforcement learning. Below, I outline some of the key ideas behind the traditional approach and implementation details that makes the program drive successfully on the simulator. If you are not interested in the technical stuff but want to try out the program, feel free to jump to the last section.
              </p>
          </div>
          <div class="blank10"></div>
          <!-- mathematical optimization -->
          <div class="span12">
            <h4>Mathematical Optimization</h4>
          </div>
            <div class="w3-full w3-container w3-margin-bottom">
              <p>
                The goal of path optimization is to minimize (or maximize) an objective function, which is similar to cost functions in supervised machine learning. The difference is that we don’t know the most optimal path so there are no actual values to compare against<sup>1</sup>. The most common approaches are to minimize the lap time directly and to minimize the curvature. However, we cannot compute the entire lap time or curvature in one go.
              </p>
              <p>
                The traditional approach to path optimization divides a track into many discrete segments where each segment will have a value alpha between 0 and 1. Having a value 0 means the car is on the left-most part of the track and 1 represents the right-most part. This set of alpha values would then define the overall reference path. Typically, the initial guess for the reference path is 0.5. Now we can go ahead and compute the lap time or curvature.
              </p>
              <p>
                Lap time can be calculated by dividing the length of each segment with the target velocity then summing up the results. The velocity profile computation is detailed in the next section. This approach is the most accurate (since minimizing lap time is the ultimate goal) but is computationally expensive. To address the speed issue, researchers have turned to minimizing curvature.
              </p>
              <p>
                Curvature, typically denoted \( \kappa \), is the inverse of the instantaneous radius of a curve \( \kappa = 1 / r \). So minimizing the curvature is equivalent to maximizing the turning radius. Similar to lap time calculation, the objective function is the sum of curvatures at each segment. Minimizing curvature has been shown to yield similar lap times but is much faster to compute<sup>2</sup>. However, it’s not enough to know what path to follow. You also need to know how fast you should be following it.
              </p>
            </div>
          <div class="w3-container w3-margin-bottom">
            <img src="../assets/img/portfolio/optimized.png" alt="" style="width:75%"/>
			<br><small>
				An optimized trajectory for the Red Bull Ring National track.
			</small
          </div>
          <div class="blank10"></div>
          <!-- Velocity Profile -->
          <div class="span12">
            <h4>Velocity Profile</h4>
          </div>
          <div class="w3-full w3-container w3-margin-bottom">
              <p>
                The velocity profile computation is divided into four steps. First, the maximum velocity is calculated for each segment. Second, you do a backward pass through the maximum velocities and compute the maximum deceleration. Third, you do a forward pass to compute the maximum acceleration while accounting for the maximum acceleration of the car at a given velocity. Lastly, to compute the final velocity profile, you take the minimum of the previous three steps.
              </p>
              <p>
                Maximum velocity is a function of radius and maximum lateral acceleration \( v_{max}^{2} = a_{lat_{max}} \cdot r \). With a bigger turning radius, you can carry more speed through the turn. However, the formula doesn’t quite hold up when the track is not completely flat.
              </p>
              <p>
                If you think about Nascar racing on oval tracks, the track surface is banked (where the side of the road that you are turning into is lower than the opposite side) which increases the maximum speed that can be carried through the turns. This is why many on/off ramps on highways will often have a slight banking. 
              </p>
              <p>
                Similarly, if the track is going uphill or downhill, then the car, impacted by gravity, would be rolling up/down the hill. This is an additional term in the car’s acceleration. I take both of these factors into account in my calculations but would be happy to chat about it if anyone is interested!
              </p>
              <p>
                For the deceleration step, you start with a local minimum velocity and work backwards to calculate the highest speed you can slow down from. This is defined by \( v_{final} = \sqrt{2 \cdot a_{long} \cdot s + v_{init}^{2}} \) where \( s \) is the distance traveled and \(a_{long} = \sqrt{(\mu \cdot g)^2 - a_{lat}^{2}} \) with \( \mu \) the coefficient of friction of the tires and \( g \) the gravitational coefficient. In practice, a car is not able to maintain its maximum grip \( \mu \) due to load transfer which I briefly discuss in step 4 of <a href="../blog/six-steps-for-fast-lap-times.html" target="_blank">this post</a>. Therefore, some form of damping is required to account for the reduced grip. My code contains a rudimentary form of it which seems to work for the test track.
              </p>
              <p>
                Acceleration follows similar steps to the deceleration step except you need to account for the force that the car can apply to its driven wheel. Even for race cars, this will not always be higher than the available grip. The formula for wheel force at a given velocity is defined by \[ F_{w} = \frac{ \tau \cdot e \cdot g_{i} * g_{f}} {r} \] where \( \tau \) is the engine torque in \(N \cdot m \) <br> \( e \) is the drivetrain efficiency <br> \( g_{i} \) is the gear ratio for gear \( i \) <br> \( g_{f} \) is the final drive ratio <br> \( r \) is the wheel radius in meters.
			  </p>
			  <p>One thing I left out here was whether the car is front-wheel drive, rear-wheel drive, or all-wheel drive. Depending on the amount of vertical load on the driven wheels, the car’s overall coefficient of friction will be impacted. So the wheel force equation always overestimates the acceleration but not in a catastrophically detrimental way.
              </p>
              <p>
                Clearly, there is much room for improvement in my implementation of the velocity profile calculation.It does not account for the load transfer during acceleration which limits the overall grip. In addition, it does not take into account aerodynamic forces that can play a major role in certain vehicles. However, it was good enough to get things working and as a solo developer, I had to manage my scope ruthlessly.
              </p>
          </div>
		  <!-- Controller -->
          <div class="span12">
            <h4>Controller</h4>
          </div>
		  <div class="w3-full w3-container w3-margin-bottom">
              <p>
                The algorithm used for the controller is largely from the <a href="./av1.html" target="_blank">first course</a> of Coursera's self-driving car specialization. There were some tweaks made such as zeroing out the integral portion of the PID controller as I could not accurately model the velocity profile and the game will share the car’s exact velocity so there is no error that needs to be accounted for. The underlying algorithm largely remains unchanged.
              </p>
              <p>
                To actually control the car in-game, I used the <a href="https://pypi.org/project/vgamepad/" target="_blank">vgamepad package</a> which is a virtual controller that runs on Python. Once the target throttle, brake, and steering values are calculated, the controller is updated with the target values. One thing to note is that I had to adjust control settings such as steering speed and steering gamma within Assetto Corsa to ensure that the controller inputs translated as close as possible to 1:1 in the game.
              </p>
          </div>
		  <!-- Results -->
          <div class="span12">
            <h4>Results</h4>
          </div>
		  <div class="w3-full w3-container w3-margin-bottom">
              <p>
                How does this agent perform? A lap around the Red Bull Ring National track took around 1:06.8 with the agent. In comparison, the game’s default AI on 100% strength ran a best lap around 1:07.1. An elite human driver can likely go 1-2 seconds faster but I’m satisfied with the results.
              </p>
              <p>
                Do you think you can beat my time? Download my code on GitHub and let me know how you get on!
              </p>
          </div>
		  <div class="video-container w3-container w3-margin-bottom">
            <!---->
            <iframe width="560" height="315" src="https://www.youtube.com/embed/WAfiw3wnLTw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
		  <!-- How to get started -->
          <div class="span12">
            <h4>How to get started</h4>
          </div>
		  <div class="w3-full w3-container w3-margin-bottom">
              <p>
                <ul>
					<li>Install Assetto Corsa (<a href="https://store.steampowered.com/app/244210/Assetto_Corsa/" target="_blank">steam</a>)</li>
					<li>Download <a href="https://github.com/jesung/aidriver" target="_blank">AI Driver app</a> for Assetto Corsa</li>
					<li>(optional) Download <a href="https://assettocorsa.club/content-manager.html" target="_blank">Content Manager</a></li>
						<ul>
							<li>Select car and track of choice from what's available</li>
							<li>Confirm tires are the default option</li>
							<li>Practice mode with ideal conditions</li>
						</ul>
					<li>(optional) If the track you want is not available, get <a href="https://www.racedepartment.com/downloads/ai-line-helper.16016/" target="_blank">AI Line Helper</a></li>
						<ul>
							<li>Use the “Track Left” button to map the left boundary</li>
							<li>Rename side_l.csv in the game installation directory to left.csv</li>
							<li>Use the “Track Left” button to map the right boundary</li>
							<li>Rename side_l.csv in the game installation directory to right.csv</li>
							<li>Copy into the content/tracks/track_name folder under the AC Self Driving repo below</li>
						</ul>
					<li>(optional) If the car you want is not available (<a href="https://www.youtube.com/watch?v=H-Fji4-boME&ab_channel=UnleashedDrivers" target="_blank">YouTube instructions</a>></li>
						<ul>
							<li>Open Content Manager and go to the About section</li>
							<li>Click "Version" multiple times to enable developer mode</li>
							<li>Go to Content -> Cars and select the car you want</li>
							<li>Click "Unpack data" in the bottom row</li>
							<li>Copy into the content/cars/car_name folder under the AC Self Driving repo below</li>
						</ul>
					<li>Download the <a href="https://github.com/jesung/ACSelfDriving" target="_blank">AC Self Driving</a> repo</li>
						<ul>
						<li>pip install -r requirements.txt</li>
						<li>Run main.py</li>
						</ul>
				</ul>
              </p>
              <p>
                Code has been tested using Python 3.10 on a Windows 11 machine
              </p>
          </div>
		  <div class="w3-full w3-container w3-margin-bottom">
            <p>
              <i><sup>1</sup><small><a href="https://arxiv.org/ftp/arxiv/papers/2102/2102.02315.pdf" target="_blank">This paper</a> describes a machine learning approach to solve the path optimization problem so there are certainly alternatives to the traditional path optimization approach.</small></i>
              <br>
              <i><sup>2</sup><small>Kapania, N., Subosits, J., Gerdes, J. 2019. A Sequential Two-Step Algorithm for Fast Generation of Vehicle Racing Trajectories. https://arxiv.org/pdf/1902.00606.pdf, accessed January 30, 2023</small></i>
            </p>
          </div>
        </article>
  </div>

  <!-- Footer -->
  <footer>
    <div class="w3-black w3-center w3-padding-24">
      <a href="https://www.linkedin.com/in/jesungpark/" target="_blank"><i class="fab fa-linkedin fa-fw fa-2x w3-hover-opacity"></i></a>
      <a href="https://github.com/jesung" target="_blank"><i class="fab fa-github fa-fw fa-2x w3-hover-opacity"></i></a>
    </div>
  </footer>
  <!-- End page content -->


  <script>
  // Script to open and close sidebar
  function w3_open() {
    document.getElementById("mySidebar").style.display = "block";
    document.getElementById("myOverlay").style.display = "block";
  }

  function w3_close() {
    document.getElementById("mySidebar").style.display = "none";
    document.getElementById("myOverlay").style.display = "none";
  }
</script>

</body>
</html>
